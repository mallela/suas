import collections # for deque
import cv2
import numpy as np
import os.path
import Queue as Q
import glob

def folderSize(path):
	num = len([f for f in os.listdir(path) 
			if os.path.isfile(os.path.join(path, f))])
	return num

def showSavePrev(d,pathF0,pathF1,pathEmergent):	
	cv2.imshow("prevIm" , cv2.resize(cv2.imread(pathF0+'DSC_%s.JPG'%(d)),None, fx = .25, fy = .25))
	l = cv2.waitKey(0)	
	if l == ord('w'): # previous save
		cv2.imwrite(pathF1+'DSC_%s.JPG'%(folderSize(pathF1)+1), cv2.imread(pathF0+'DSC_%s.JPG'%(d)))
	elif l ==ord('e'):
		cv2.imwrite(pathEmergent+'DSC_%s.JPG'%(folderSize(pathEmergent)+1), cv2.imread(pathF0+'DSC_%s.JPG'%(d)))
	##Idk why no "else:" also works o.O
	cv2.destroyWindow("prevIm")# do not remove destroyWindow() for "prevIm"!
	
def qDeq(x):
	q = Q.PriorityQueue()
	d = collections.deque()
	for i in x:
		dirName, fileName = os.path.split(i)
		shortName,_ = os.path.splitext(fileName)
		_,fir= shortName.split('_')
		print fir	
		q.put((fir))
	while not q.empty():
		d.append(q.get())
	print d
	return d

def slideShow(d, pathF0, pathF1,pathEmergent, folderSizeBefore, sizFlag):
	if (sizFlag):
		x = folderSizeBefore-1 # works over x = folderSizeBefore o.O idk why. Works in a strange way too. Starts looking at the folder last img first.
	else:
		x = 1
	for  i in range(x, len(d)):
		cv2.imshow("currentIm" , cv2.resize(cv2.imread(pathF0+'DSC_%s.JPG'%(d[i])),None, fx = .25, fy = .25))
		k = cv2.waitKey(0)
		if k == ord('q'): # (save current) or (save current and prev)
			# qq = save & move on ; qww = save, view previous,save prev
			cv2.imwrite(pathF1+'DSC_%s.JPG'%(folderSize(pathF1)+1), cv2.imread(pathF0+'DSC_%s.JPG'%(d[i])))
			m = cv2.waitKey(0)
			cv2.destroyWindow("currentIm")
			if m == ord('w'): 
				showSavePrev(d[i-1],pathF0,pathF1,pathEmergent)
		elif k == ord('e'):
			cv2.imwrite(pathEmergent+'DSC_%s.JPG'%(folderSize(pathEmergent)+1), cv2.imread(pathF0+'DSC_%s.JPG'%(d[i])))
			m = cv2.waitKey(0)
			cv2.destroyWindow("currentIm")
			if m == ord('w'): 
				showSavePrev(d[i-1],pathF0,pathF1,pathEmergent)
		elif k == ord('w'): # ww = view previous, save previous
			showSavePrev(d[i-1],pathF0,pathF1,pathEmergent)
		elif k== 27:
			cv2.destroyAllWindows()
			break
		else:
			pass
	return 0
	
#if __name__ == '__main__':
def mainProcess():
	pathF0 = '/home/praneeta/Desktop/Edhitha/F0/'
	#pathF0 = '/home/praneeta/Desktop/Edhitha/Junk/'
	pathF1 = '/home/praneeta/Desktop/Edhitha/F1/'
	pathEmergent = '/home/praneeta/Desktop/Edhitha/Emergent/'
	noNew = '/home/praneeta/Desktop/Edhitha/noNew.JPG'
	siz = 0
	sizFlag = 0
	while True:
		x = glob.glob(pathF0+'*.JPG')
		print "size is%d"%(siz)
		if siz !=folderSize(pathF0):
			folderSizeBefore = siz
			siz = folderSize(pathF0)
			print "new size is%d"%(siz)
			sizFlag = 1		
			d = qDeq(x)
			slideShow(d, pathF0, pathF1, pathEmergent, folderSizeBefore, sizFlag)
			
		else :
			sizFlag = 0
			print "waiting..."
			k = cv2.waitKey(0)
			if k:
				cv2.imshow("currentIm", cv2.imread(noNew))
		if cv2.waitKey(0)==27:
			cv2.destroyAllWindows()
			break
